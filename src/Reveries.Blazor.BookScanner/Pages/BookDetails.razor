@page "/book/{Isbn}"
<PageTitle>Reveries | @(_book?.Title ?? "Book Details")</PageTitle>
@inject BookApiClient BooksApi
@inject BookState BookState

@if (_book == null)
{
    <LoadingSpinner Message="Loading book details..." />
}
else
{
    <div class="container py-4 mt-4 book-details-container">

        <div class="row g-2">
            <!-- Image -->
            <div class="col-12 col-md-5 position-relative text-center mb-3">
                <img src="@_book.ImageUrl"
                     class="book-cover img-fluid rounded shadow mb-3"
                     alt="@_book.Title" />
            </div>

            <!-- Book Details -->
            <div class="col-12 col-md-7">
                <!-- Title -->
                <div>
                    <h1 class="book-title mb-1">@_book.Title</h1>
                </div>
                
                <!-- Series -->
                @if (!string.IsNullOrEmpty(_book.Series))
                {
                    <h5 class="text-muted mb-3">
                        Part of "@_book.Series"@(_book.NumberInSeries.HasValue ? $" - Book #{_book.NumberInSeries}" : "")
                    </h5>
                }
                
                <!-- Author -->
                <div class="author-info">
                    <i class="bi bi-person author-icon"></i>
                    <div class="text-muted author-name">by @string.Join(", ", _book.Authors ?? [])</div>
                </div>

                
                <!-- Subjects -->
                @if (_book.Subjects?.Any() == true)
                {
                    <div class="subject-badges">
                        @foreach (var subject in _book.Subjects)
                        {
                            <span class="subject-badge">@subject</span>
                        }
                    </div>
                }
                
                <hr class="my-3 border border-secondary opacity-25 rounded" />
                
                <!-- Meta -->
                <div class="book-meta book-grid mb-3">
                    <!-- ISBN -->
                    <div class="book-info">
                        <i class="bi bi-hash icon"></i>
                        <div>
                            <div class="label">ISBN</div>
                            <div class="value">
                                @(_book.Isbn13 is not null && _book.Isbn13 != string.Empty 
                                    ? _book.Isbn13 
                                    : _book.Isbn10)
                            </div>
                        </div>
                    </div>
                    
                    <!-- Pages -->
                    <div class="book-info">
                        <i class="bi bi-book icon"></i>
                        <div>
                            <div class="label">Pages</div>
                            <div class="value">@_book.Pages</div>
                        </div>
                    </div>

                    <!-- Publisher -->
                    <div class="book-info">
                        <i class="bi bi-shop icon"></i>
                        <div>
                            <div class="label">Publisher</div>
                            <div class="value">@_book.Publisher</div>
                        </div>
                    </div>
                    
                    <!-- Publication date -->
                    <div class="book-info">
                        <i class="bi bi-calendar icon"></i>
                        <div>
                            <div class="label">Publication Date</div>
                            <div class="value">@_book.FormattedDate()</div>
                        </div>
                    </div>
                    
                    <!-- Language -->
                    <div class="book-info">
                        <i class="bi bi-globe icon"></i>
                        <div>
                            <div class="label">Language</div>
                            <div class="value">@_book.Language</div>
                        </div>
                    </div>
                    
                    <!-- Binding -->
                    <div class="book-info">
                        <i class="bi bi-journal icon"></i>
                        <div>
                            <div class="label">Binding</div>
                            <div class="value">@_book.Binding</div>
                        </div>
                    </div>
                    
                    <!-- Edition -->
                    <div class="book-info">
                        <i class="bi bi-tag icon"></i>
                        <div>
                            <div class="label">Edition</div>
                            <div class="value">@_book.Edition</div>
                        </div>
                    </div>

                    <!-- MSRP -->
                    <div class="book-info">
                        <i class="bi bi-currency-dollar icon"></i>
                        <div>
                            <div class="label">Price</div>
                            <div class="value">@_book.Msrp</div>
                        </div>
                    </div>
                    
                    <!-- Dimensions -->
                    <div class="book-info">
                        <i class="bi bi-rulers icon"></i>
                        <div>
                            <div class="label">Dimensions</div>
                            <div class="value">@_book.Dimensions?.HeightCm × @_book.Dimensions?.WidthCm × @_book.Dimensions?.ThicknessCm cm</div>
                        </div>
                    </div>
                    
                    <!-- Weight -->
                    <div class="book-info">
                        <i class="bi bi-box icon"></i>
                        <div>
                            <div class="label">Weight</div>
                            @if (_book.Dimensions?.WeightG != null)
                            {
                                <div class="value">@_book.Dimensions?.WeightG g</div>
                            }
                        </div>
                    </div>
                    
                    @if (_book.DeweyDecimal?.Any() == true)
                    {
                        <!-- Dewey Decimal -->
                        <div class="book-info">
                            <i class="bi bi-123 icon"></i>
                            <div>
                                <div class="label">Dewey Decimal</div>
                                @if (_book.DeweyDecimal != null)
                                {
                                    <div class="value">@string.Join(", ", _book.DeweyDecimal)</div>
                                }
                            </div>
                        </div>
                    }
                    
                    <!-- Datasource -->
                    <div class="book-info">
                        <i class="bi bi-database icon"></i>
                        <div>
                            <div class="label">Datasource</div>
                            <div class="value"><BookSourceBadge DataSource="@_book.DataSource"/></div>
                        </div>
                    </div>
                </div>
                
                <hr class="my-3 border border-secondary opacity-25 rounded" />
                
                <!-- Synopsis -->
                @if (!string.IsNullOrEmpty(_book.Synopsis))
                {
                    <div class="synopsis-title mb-2">
                        Synopsis
                    </div>
                    <div class="synopsis">
                        <p class="synopsis-text mb-1">
                            @(_showFullSynopsis
                                ? _book.Synopsis.ToMarkup()
                                : _book.Synopsis.Length > MaxSynopsisLength
                                    ? _book.Synopsis.Substring(0, MaxSynopsisLength).ToMarkup()
                                    : _book.Synopsis.ToMarkup())
                        </p>

                        @if (_book.Synopsis.Length > MaxSynopsisLength)
                        {
                            <button class="btn btn-link p-0 text-muted fw-semibold mb-5"
                                    @onclick="ToggleSynopsis">
                                @(_showFullSynopsis ? "Show less" : "Show more")
                            </button>
                        }
                    </div>
                }

            </div>
        </div>
        
    </div>
}

@code {
    [Parameter] public string? Isbn { get; set; }
    private BookDto? _book;
    private bool _showFullSynopsis;
    private const int MaxSynopsisLength = 300;

    private void ToggleSynopsis()
    {
        _showFullSynopsis = !_showFullSynopsis;
    }

    protected override async Task OnInitializedAsync()
    {
        if (BookState.CurrentBook != null && BookState.CurrentBook.Isbn13 == Isbn)
        {
            _book = BookState.CurrentBook;
        }
        else if (!string.IsNullOrEmpty(Isbn))
        {
            _book = await BooksApi.GetAsync(Isbn);
        }
    }
}